<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>商品添加</title>
    <link rel="stylesheet" href="../layui-master/src/css/layui.css">
    <link rel="stylesheet" href="../layui-master/dist/css/layui.css">


    <style>
        .layui-table .layui-table-cell {
            height: 100px;
        }

        .layui-table .layui-table-cell img {
            height: 100px;
            width: 150px
        }

        .layui-upload-list {
            width: 120px;
            height: 110px;
        }

        #uploadimg {

            height: 90%;
            border-color: #fff
        }

        .layui-body {
            padding-top: 30px;
        }

        #goodssign {
            width: 400px;
        }




        /* #demo2 img {
            width: 100px;
            height: 100px;
            float: left;
            margin-left: 10px;
        } */
    </style>
</head>

<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
        <div class="layui-header">
            <div class="layui-logo">layui 后台布局</div>
            <!-- 头部区域（可配合layui已有的水平导航） -->
            <ul class="layui-nav layui-layout-left">
                <li class="layui-nav-item"><a href="">控制台</a></li>
                <li class="layui-nav-item"><a href="">商品管理</a></li>
                <li class="layui-nav-item">
                    <a href="javascript:;">用户</a>
                    <dl class="layui-nav-child">
                        <dd><a href="">用户列表</a></dd>
                        <dd><a href="">用户管理</a></dd>
                    </dl>
                </li>
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item">
                    <a href="javascript:;">
                        <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                        贤心
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;">基本资料</a></dd>
                        <dd><a href="javascript:;">安全设置</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="javascript:;">退了</a></li>
            </ul>
        </div>

        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <ul class="layui-nav layui-nav-tree" lay-filter="test">
                    <li class="layui-nav-item layui-nav-itemed">
                        <a class="" href="javascript:;">商品管理</a>
                        <dl class="layui-nav-child">
                            <dd><a href="./list.html">商品列表</a></dd>

                            <dd><a href="./addgoods.html">添加商品</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">订单管理</a>
                        <dl class="layui-nav-child">
                            <dd><a href="./order.html">订单列表</a></dd>
                        </dl>
                    </li>
                    <!--         <li class="layui-nav-item"><a href="javascript:;">云市场</a></li>
        <li class="layui-nav-item"><a href="javascript:;">发布商品</a></li> -->
                </ul>
            </div>
        </div>

        <div class="layui-body">
            <!-- 内容主体区域 -->
            <form class="layui-form" action="">
                <div class="layui-form-item">
                    <label class="layui-form-label">商品</label>
                    <div class="layui-input-block">
                        <input type="text" lay-verify="title" autocomplete="off" placeholder="请输入商品名"
                            class="layui-input" style="width:400px;" id="goodsname">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">原价</label>
                        <div class="layui-input-inline">
                            <input type="text" lay-verify="required" placeholder="请输入" autocomplete="off"
                                class="layui-input" id="goodsoldprice">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">现价</label>
                        <div class="layui-input-inline">
                            <input type="tex" lay-verify="required" placeholder="请输入" autocomplete="off"
                                class="layui-input" id="goodsnewprice">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">数量</label>
                        <div class="layui-input-inline">
                            <input type="text" lay-verify="required" placeholder="请输入" autocomplete="off"
                                class="layui-input" id="goodscount">
                        </div>
                    </div>
                </div>


                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">验证日期</label>
                        <div class="layui-input-inline">
                            <input type="text" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off"
                                class="layui-input" id="goodstime">
                        </div>
                    </div>

                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea placeholder="请输入内容" class="layui-textarea" id="goodssign"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">图片</label>
                    <div class="layui-input-block">
                        <div class="layui-upload">
                            <button type="button" class="layui-btn" id="test1">上传图片</button>
                            <div class="layui-upload-list">
                                <img class="layui-upload-img" id="uploadimg">
                                <p id="demoText"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="layui-upload">
                    <button type="button" class="layui-btn" id="test2">多图片上传</button>
                    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                        预览图：
                        <div class="layui-upload-list" id="demo2"></div>
                    </blockquote>
                </div> -->




                <!--<div class="layui-form-item layui-form-text">
                      <label class="layui-form-label">编辑器</label>
                      <div class="layui-input-block">
                        <textarea class="layui-textarea layui-hide" name="content" lay-verify="content" id="LAY_demo_editor"></textarea>
                      </div>
                    </div>-->
                <!-- <button type="button" class="layui-btn" id="test1">
                    <i class="layui-icon">&#xe67c;</i>上传图片
                </button> -->

                <script src="../layui-master/src/layui.js"></script>
                <script>

                    var showimg = document.getElementById('uploadimg')

                    layui.use('upload', function () {
                        var upload = layui.upload;

                        //     //执行实例
                        var uploadInst = upload.render({
                            elem: '#test1' //绑定元素
                            , url: '/addimg' //上传接口
                            // , auto: false
                            // , bindAction: '#form-btn'
                            // , choose: function (obj) {
                            //     console.log(obj.pushFile())
                            // }
                            , done: function (res) {
                                //上传完毕回调
                                console.log(res)
                                // showimg.src = '../' + res.imgurl;
                                showimg.style.width = '90%';
                            }
                            , error: function () {
                                //请求异常回调

                            }
                        });
                    });
                    // layui.use('upload', function () {
                    //     var $ = layui.jquery
                    //     upload = layui.upload;
                    //     upload.render({
                    //         elem: '#test2'
                    //         , url: '/addimg'
                    //         , multiple: true
                    //         , auto: false
                    //         , bindAction: '#form-btn'
                    //         , choose: function (obj) {
                    //             obj.preview(function (index, file, result) {
                    //                 $('#demo2').append('<img src="' + result + '" alt="' + file.name + '" class="layui-upload-img">')
                    //             });
                    //         }
                    //         , before: function (obj) {
                    //             //预读本地文件示例，不支持ie8

                    //         }
                    //         , done: function (res) {
                    //             //上传完毕
                    //             console.log(res)
                    //         }
                    //     })
                    // });
                </script>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <!-- <button class="layui-btn" lay-submit="">立即提交</button> -->
                        <input type="button" value="立即提交" class="layui-btn" id="form-btn">
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- <div class="layui-footer">
            

        </div> -->
    </div>
    <script>
        //JavaScript代码区域
        layui.use('element', function () {
            var element = layui.element;
        });
    </script>
    <script src="../layui-master/examples/js/index.js"></script>
    <script>
        //JavaScript代码区域
        // layui.use('element', function () {
        //     var element = layui.element;

        // });

        var goodsname = document.getElementById('goodsname');
        var goodsoldprice = document.getElementById('goodsoldprice');
        var goodsnewprice = document.getElementById('goodsnewprice');
        var goodscount = document.getElementById('goodscount');
        var goodstime = document.getElementById('goodstime');
        var goodssign = document.getElementById('goodssign');
        var showimg = document.getElementById('uploadimg');


        //通过地址中的ID，查数据库，获得该id的数据
        function checkgoods() {

            if (location.search.slice(1)) {
                var goodsdata = location.search.slice(1).split('=')[1];
                let xhr = new XMLHttpRequest();
                // var data = '_id=' + goodsdata;
                xhr.open('get', '/updategoods?' + goodsdata, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');


                xhr.send();
                xhr.onload = () => {

                    var res = JSON.parse(xhr.responseText)[0];
                    console.log(res);
                    // console.log() 
                    goodsname.setAttribute('data-id', res._id);
                    goodsname.value = res.goods;
                    goodsoldprice.value = res.oldprice;
                    goodsnewprice.value = res.newprice;
                    goodscount.value = res.left;
                    goodstime.value = res.joinTime;
                    goodssign.value = res.sign;
                    showimg.src = '../' + res.img;
                }
            }
        }
        checkgoods();





        var formbtn = document.getElementById('form-btn');


        formbtn.onclick = function () {
            var goodsname = document.getElementById('goodsname');
            var goodsoldprice = document.getElementById('goodsoldprice');
            var goodsnewprice = document.getElementById('goodsnewprice');
            var goodscount = document.getElementById('goodscount');
            var goodstime = document.getElementById('goodstime');
            var goodssign = document.getElementById('goodssign');
            var showimg = document.getElementById('uploadimg');
            // console.log(showimg)
            var dataobj = {
                "goods": goodsname.value,
                "oldprice": goodsoldprice.value,
                "newprice": goodsnewprice.value,
                "sign": goodssign.value,
                "left": goodscount.value,
                "status": '上线',
                "joinTime": goodstime.value,
                "img": (showimg.src).split('3001/')[1]
            }
            if (location.search.slice(1)) {
                var dataobj = `_id=${goodsname.dataset.id}&goods=${goodsname.value}&oldprice=${goodsoldprice.value}&newprice=${goodsnewprice.value}&sign=${goodssign.value}&left=${goodscount.value}&status=上线&joinTime=${goodstime.value}&img=${(showimg.src).split('3001/')[1]}`;
                // console.log(dataobj)
                updategoods(dataobj)
            } else {
                // console.log(00)
                var dataobj = `goods=${goodsname.value}&oldprice=${goodsoldprice.value}&newprice=${goodsnewprice.value}&sign=${goodssign.value}&left=${goodscount.value}&status=上线&joinTime=${goodstime.value}&img=${(showimg.src).split('3001/')[1]}`;
                addgoods(dataobj);
            }

            // console.log(dataobj)


        }
        function addgoods(obj) {
            let xhr = new XMLHttpRequest();

            xhr.open('post', '/addgoods', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            // console.log(obj)
            // var res = obj;
            xhr.send(obj);
            xhr.onload = () => {
                var responseobj = JSON.parse(xhr.responseText)

                if (responseobj.code == 2) {
                    alert("插入成功")
                }
            }

        }

        function updategoods(obj) {
            let xhr = new XMLHttpRequest();

            xhr.open('post', '/updategoods', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            // console.log(obj)
            // var res = obj;
            xhr.send(obj);
            xhr.onload = () => {
                // console.log(xhr.responseText)
                var responseobj = JSON.parse(xhr.responseText)
                if (responseobj.code == 1) {
                    alert("更改成功")
                }
            }
        }
    </script>
</body>

</html>